const storage=require("uxp").storage,fs=storage.localFileSystem,userFileName="user.cfg",searchHistoryFileName="searchHistory.cfg",{alert:alert,error:error}=require("../lib/dialogs");function Helpers(){}Helpers.prototype.Request=function(e,t,r,a){let o={};return"POST"===t?(o={method:"POST",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},a&&(o.headers.Authorization=a)):o={method:"GET"},fetch(encodeURI(e),o).then(function(e){if(e.ok)return e.json();var t=new Error(e.statusText);throw t.response=e,t.message=`Request had an error: ${e.status} - ${e.statusText} - ${e.text()}`,t})},Helpers.prototype.BinaryRequest=function(e){e.url&&(e=e.url);return fetch(encodeURI(e),{method:"GET"}).then(function(e){if(e.ok)return e.arrayBuffer();var t=new Error(e.statusText);throw t.response=e,t.message=`Request had an error: ${e.status} - ${e.statusText} - ${e.text()}`,t})},Helpers.prototype.Base64ArrayBuffer=function(e){let t="";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=new Uint8Array(e),o=a.byteLength,n=o%3,i=o-n;let s,l,u,c,f;for(let e=0;e<i;e+=3)t+=r[s=(16515072&(f=a[e]<<16|a[e+1]<<8|a[e+2]))>>18]+r[l=(258048&f)>>12]+r[u=(4032&f)>>6]+r[c=63&f];return 1===n?t+=`${r[s=(252&(f=a[i]))>>2]}${r[l=(3&f)<<4]}==`:2===n&&(t+=`${r[s=(64512&(f=a[i]<<8|a[i+1]))>>10]}${r[l=(1008&f)>>4]}${r[u=(15&f)<<2]}=`),t},Helpers.prototype.Base64=function(){let e={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var r,a,o,n,i,s,l,u="",c=0;for(t=e._utf8_encode(t);c<t.length;)n=(r=t.charCodeAt(c++))>>2,i=(3&r)<<4|(a=t.charCodeAt(c++))>>4,s=(15&a)<<2|(o=t.charCodeAt(c++))>>6,l=63&o,isNaN(a)?s=l=64:isNaN(o)&&(l=64),u=u+this._keyStr.charAt(n)+this._keyStr.charAt(i)+this._keyStr.charAt(s)+this._keyStr.charAt(l);return u},decode:function(t){var r,a,o,n,i,s,l="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<t.length;)r=this._keyStr.indexOf(t.charAt(u++))<<2|(n=this._keyStr.indexOf(t.charAt(u++)))>>4,a=(15&n)<<4|(i=this._keyStr.indexOf(t.charAt(u++)))>>2,o=(3&i)<<6|(s=this._keyStr.indexOf(t.charAt(u++))),l+=String.fromCharCode(r),64!=i&&(l+=String.fromCharCode(a)),64!=s&&(l+=String.fromCharCode(o));return l=e._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",r=0;r<e.length;r++){var a=e.charCodeAt(r);a<128?t+=String.fromCharCode(a):a>127&&a<2048?(t+=String.fromCharCode(a>>6|192),t+=String.fromCharCode(63&a|128)):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128),t+=String.fromCharCode(63&a|128))}return t},_utf8_decode:function(e){for(var t="",r=0,a=c1=c2=0;r<e.length;)(a=e.charCodeAt(r))<128?(t+=String.fromCharCode(a),r++):a>191&&a<224?(c2=e.charCodeAt(r+1),t+=String.fromCharCode((31&a)<<6|63&c2),r+=2):(c2=e.charCodeAt(r+1),c3=e.charCodeAt(r+2),t+=String.fromCharCode((15&a)<<12|(63&c2)<<6|63&c3),r+=3);return t}};return e},Helpers.prototype.GetHtmlTemplate=async function(e){let t=await fs.getPluginFolder(),r=await t.getEntry("./"+e+".html");return await r.read({format:storage.formats.utf8})},Helpers.prototype.AddCSS=function(e){let t=$create("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),0===document.querySelectorAll(`link[href="${e}"]`).length&&document.getElementsByTagName("head")[0].appendChild(t)},Helpers.prototype.ShowAlert=async function(e,t){await alert(e,t)},Helpers.prototype.ShowError=async function(e,t){await error(e,t)},Helpers.prototype.ResizeProportionally=function(e,t,r,a){let o=0,n={};return o=r/e,n.width=r,n.height=t*o,t*=o,e*=o,n},Helpers.prototype.CreateDialog=function(e,t){return this.dialog||(this.dialog=document.createElement("dialog"),this.dialog.innerHTML=e,document.appendChild(this.dialog)),this.dialog.addEventListener("close",t),this.dialog},Helpers.prototype.Random=function(e){return e?e[Math.floor(Math.random()*e.length)]:Math.floor(Math.random())};let guid=function(){let e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};Helpers.prototype.GeneratePassword=function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="",r=0,a=e.length;r<8;++r)t+=e.charAt(Math.floor(Math.random()*a));return t},Helpers.prototype.GetUser=async function(){const e=await fs.getDataFolder(),t=await e.getEntries();if(t.length){let r;if(t.forEach(e=>{"user.cfg"===e.name&&(r=e)}),r)return await r.read();{const t=await e.createEntry("user.cfg",{overwrite:!0});let r=guid();return t.write(r),r}}{const t=await e.createEntry("user.cfg",{overwrite:!0});let r=guid();return t.write(r),r}},Helpers.prototype.GetSearchHistory=async function(){const e=await fs.getDataFolder(),t=await e.getEntries();if(t.length){let r;if(t.forEach(e=>{"searchHistory.cfg"===e.name&&(r=e)}),r)return JSON.parse(await r.read());{let t=[];return(await e.createEntry("searchHistory.cfg",{overwrite:!0})).write(JSON.stringify(t)),t}}{let t=[];return(await e.createEntry("searchHistory.cfg",{overwrite:!0})).write(JSON.stringify(t)),t}},Helpers.prototype.SaveSearchHistory=async function(e){const t=await fs.getDataFolder(),r=await t.getEntries();if(r.length){let t;if(r.forEach(e=>{"searchHistory.cfg"===e.name&&(t=e)}),t)return await t.write(JSON.stringify(e))}},Helpers.prototype.RemoveDuplicates=function(e,t){let r=[];if(t)r=e.map(e=>e[t]).map((e,t,r)=>r.indexOf(e)===t&&t).filter(t=>e[t]).map(t=>e[t]);else for(let t=0;t<e.length;t++)-1==r.indexOf(e[t])&&r.push(e[t]);return r},Helpers.prototype.GetExtensionList=function(){return[{value:void 0,text:"Random"},{value:"app",text:".app"},{value:"bat",text:".bat"},{value:"exe",text:".exe"},{value:"com",text:".com"},{value:"msi",text:".msi"},{value:"scexe",text:".scexe"},{value:"7z",text:".7z"},{value:"dmg",text:".dmg"},{value:"gz",text:".gz"},{value:"iso",text:".iso"},{value:"jar",text:".jar"},{value:"rar",text:".rar"},{value:"tar",text:".tar"},{value:"zip",text:".zip"},{value:"aac",text:".aac"},{value:"flac",text:".flac"},{value:"m4a",text:".m4a"},{value:"mp3",text:".mp3"},{value:"wav",text:".wav"},{value:"midi",text:".midi"},{value:"avi",text:".avi"},{value:"flv",text:".flv"},{value:"mp4",text:".mp4"},{value:"mpeg",text:".mpeg"},{value:"wmv",text:".wmv"},{value:"mkv",text:".mkv"},{value:"bmp",text:".bmp"},{value:"gif",text:".gif"},{value:"jpg",text:".jpg"},{value:"png",text:".png"},{value:"tif",text:".tif"},{value:"txt",text:".txt"},{value:"rtf",text:".rtf"},{value:"docx",text:".docx"},{value:"xlsx",text:".xlsx"},{value:"pptx",text:".pptx"},{value:"pdf",text:".pdf"}]},Helpers.prototype.GetRGs=function(e){return e.items[0]?e.items.filter(e=>"RepeatGrid"===e.constructor.name):[]},Helpers.prototype.MakeRGList=function(e,t,r,a){e.innerHTML="",t.forEach((t,r)=>{let a=$create("option");a.innerHTML=t.name,a.value=r,e.appendChild(a)}),setTimeout(()=>{e.value=r||0,e.options.some(function(t,r){if(t.value===e.value)return t.selected=!0,t.setAttribute("selected",!0),e.selectedIndex=r,!0}),e.addEventListener("change",a),a.call(e)},50)},module.exports=new Helpers;