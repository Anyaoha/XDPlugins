const{editDocument:editDocument}=require("application"),Helpers=require("../../util/helpers"),ImageService=require("../../service/ImageService"),Usage=require("../../service/UsageService"),OptimizeService=require("../../service/OptimizeService");let Optimize,explore,actionFooter,optimizeBtn,shuffleBtn,addBtn,context,loadingSpinner,imageResults,backButton,searchBox,searchBtn,noResults,progress,progressText,progressBar,orientation,gridSize,RepeatGrid,getElements=function(){backButton=$first("#backButton"),searchBox=$first("#searchImageBox"),searchBtn=$first("#searchImageBtn"),explore=$first("#exploreUnsplash"),actionFooter=$first("#actionFooter"),shuffleBtn=$first("#shuffleBtn"),addBtn=$first("#addBtn"),loadingSpinner=$first("#loadingSpinner"),imageResults=$first("#imageResults"),noResults=$first("#noResults"),progress=$first("#downloadProgressIndicator"),progressText=$first("#progressText"),progressBar=$first("#progressBar"),optimizeBtn=$first("#optimizeBtn")},clearResults=function(){imageResults.innerHTML=""},disableAll=function(e){searchBox.disabled=e,backButton.disabled=e,searchBtn.disabled=e,optimizeBtn.disabled=e,shuffleBtn.disabled=e,addBtn.disabled=e,RepeatGrid.cellContent.htmlElement.disabled=e,RepeatGrid.cellContent.items.forEach(t=>{t.htmlElement&&(t.htmlElement.disabled=e)})},showProgress=function(e,t){progressBar.value=e,progressBar.setAttribute("step",1),progressBar.setAttribute("max",t),progressText.innerHTML=`Downloading image ${e} of ${t}`,"flex"!==progress.style.display&&(progress.style.display="flex")},hideProgress=function(){progress.style.display="none",progressText.innerHTML="",progressBar.value=0},showResults=function(){imageResults.style.display="flex",loadingSpinner.style.display="none",noResults.style.display="none",hideExplore(),disableAll(!1),ImageService.DisableLockUnlock(),ImageService.EnableLockUnlock(),searchBox.focus()},searchExplore=function(){searchBox.value=this.getAttribute("data-search"),search()},showExplore=function(){explore.style.display="block",backButton.style.display="none",actionFooter.style.display="none",loadingSpinner.style.display="none",imageResults.style.display="none",noResults.style.display="none";let e=$all(".category-title"),t=$all(".subcategory");e.forEach(e=>{e.addEventListener("click",searchExplore)}),t.forEach(e=>{e.addEventListener("click",searchExplore)}),backButton.removeEventListener("click",showExplore),optimizeBtn.removeEventListener("click",Optimize.Toggle),shuffleBtn.removeEventListener("click",shuffle),addBtn.removeEventListener("click",add),searchBox.value=""},hideExplore=function(){explore.style.display="none",backButton.style.display="block",actionFooter.style.display="flex";let e=$all(".category-title"),t=$all(".subcategory");e.forEach(e=>{e.removeEventListener("click",searchExplore)}),t.forEach(e=>{e.removeEventListener("click",searchExplore)}),backButton.addEventListener("click",showExplore),optimizeBtn.addEventListener("click",Optimize.Toggle),shuffleBtn.addEventListener("click",shuffle),addBtn.addEventListener("click",add)},showLoading=function(){loadingSpinner.style.display="flex",imageResults.style.display="none",noResults.style.display="none",hideExplore()},showNoResults=function(){noResults.style.display="flex",loadingSpinner.style.display="none",imageResults.style.display="none",hideExplore(),disableAll(!1),searchBox.focus()},showPhotos=function(e){e.length?(e.forEach(e=>{imageResults.innerHTML+=ImageService.GetPhotoCard(e,orientation)}),showResults()):showNoResults()},search=function(){clearResults(),showLoading(),disableAll(!0),ImageService.Search(gridSize,orientation,searchBox.value||"").then(e=>{showPhotos(e)}).catch(e=>{showNoResults(),hideProgress()})},shuffle=function(){let e=ImageService.Shuffle(gridSize);e&&e.length?(clearResults(),showPhotos(e)):search()},add=function(){editDocument({editLabel:"Add images to Repeat Grid"},async e=>(disableAll(!0),ImageService.Apply(showProgress,RepeatGrid.selectedItem.sceneNode,context).then(async function(e){await RepeatGrid._rg.attachImageDataSeries(RepeatGrid.selectedItem.sceneNode,e),hideProgress(),disableAll(!1),Usage.Apply()}).catch(function(e){disableAll(!1),hideProgress()})))},bindSearch=function(){searchBtn.addEventListener("click",function(){searchBox.value?(ImageService.CurrentPage=1,search(),Usage.ImageSearch(searchBox.value)):showExplore()}),searchBox.addEventListener("keydown",e=>{e.preventDefault(),e.stopPropagation(),(e.keyCode&&13===e.keyCode||e.code&&"Enter"===e.code)&&(searchBox.value?(ImageService.CurrentPage=1,search(),Usage.ImageSearch(searchBox.value)):showExplore())})};function ImagePanel(){}ImagePanel.prototype.Create=function(e,t,s){Helpers.AddCSS("/partial/image/style.css"),ImageService.Images.length=0,context=s,gridSize=(RepeatGrid=e).rows*RepeatGrid.cols,orientation=RepeatGrid.selectedItem.orientation,ImageService.GetView().then(e=>{t.innerHTML=e,ImageService.CurrentPage=1,Optimize=new OptimizeService,getElements(),bindSearch(),showExplore(),searchBox.focus()}),this.Created=!0},ImagePanel.prototype.Destroy=function(){this.Created=!1,Optimize=void 0,RepeatGrid=void 0,gridSize=void 0,orientation=void 0},module.exports=new ImagePanel;