const{ImageFill:ImageFill,Rectangle:Rectangle}=require("scenegraph"),application=require("application"),storage=require("uxp").storage,fs=storage.localFileSystem,Config=require("../config/production").Images,Helpers=require("../util/helpers"),UnsplashService=require("./UnsplashService");let picturesNeeded,lockUnlockBind=function(e){this.LockUnlock(e,this)};function ImageService(){this.View="partial/image/view",this.ResultsPerPage=30,this.CurrentPage=1,this.Images=[],this.PhotoResults=[],this.QUALITY_DEF={active:Config.RESIZE,scale:Config.SCALE,quality:Config.QUALITY},this.QUALITY_SAVED={active:Config.RESIZE,scale:Config.SCALE,quality:Config.QUALITY}}ImageService.prototype.GetView=function(){return Helpers.GetHtmlTemplate(this.View)},ImageService.prototype.GetPhotoCard=function(e,t){let a=e.urls.small,i={link:e.user.links.html+"?utm_source=repetor&utm_medium=referral",name:e.user.name};return'<div class="image-card">'+`<div class="image ${t}">`+`<img src="${a}"/>`+`<div class="image-selection" id="${e.id}">`+'<div class="unlock"></div></div>'+`<div class="sel-marker" style="display: ${e.locked?"block":"none"}"></div>`+"</div>"+`<div class="author"><a href="${i.link}">Â©&nbsp;${i.name.toUpperCase()}</a></div>`+"</div>"},ImageService.prototype.LockUnlock=function(e,t){let a,i=e.target.id?e.target:e.target.parentNode,l=i.nextSibling;t.Images.some(function(e){if(e.id===i.id)return e.locked=!e.locked,a=e.locked,!0}),a?(l.style.display="block",picturesNeeded--):(l.style.display="none",picturesNeeded++)},ImageService.prototype.EnableLockUnlock=function(){let e=this;$all(".image-selection").forEach(t=>{t.addEventListener("click",lockUnlockBind.bind(e))})},ImageService.prototype.DisableLockUnlock=function(){$all(".image-selection").forEach(e=>{e.removeEventListener("click",lockUnlockBind)})},ImageService.prototype.PlacePhotos=function(e){picturesNeeded=e;let t=this;if(t.Images=t.Images.filter(e=>e.locked),picturesNeeded=e-t.Images.length,t.PhotoResults.length)for(var a=t.Images.length;a<e;a++){var i=Math.floor(Math.random()*t.PhotoResults.length),l=t.PhotoResults.splice(i,1)[0];t.Images.push(l)}},ImageService.prototype.Search=function(e,t,a){let i=this,l=Math.ceil(e/i.ResultsPerPage);return UnsplashService.Search.Photos(t,i.ResultsPerPage,i.CurrentPage,a).then(s=>{let o;if(i.TotalPages=s.total_pages,o=s.results,l<=1)return i.PhotoResults=o.map(e=>(e.locked=!1,e.id=Helpers.GeneratePassword(),e)),i.PlacePhotos(e),i.Images;{let s=[];for(let e=1;e<Math.min(l,i.TotalPages);e++)i.CurrentPage++,s.push(UnsplashService.Search.Photos(t,i.ResultsPerPage,i.CurrentPage,a));return Promise.all(s).then(t=>{for(let e=0;e<t.length;e++)t[e]&&t[e].results?o=o.concat(t[e].results):t[e]&&(o=o.concat(t[e]));return i.PhotoResults=o,i.PlacePhotos(e),i.Images},e=>{throw e})}},e=>{throw e})},ImageService.prototype.Shuffle=function(e){return!!picturesNeeded&&(this.PhotoResults.length-picturesNeeded>=e?(this.PlacePhotos(e),this.Images):(this.CurrentPage<this.TotalPages?this.CurrentPage++:this.CurrentPage=1,!1))},ImageService.prototype.Resize=async function(e,t,a){let i=this,l=[],s=[],o=t.globalBounds.width,r=t.globalBounds.height;if(i.QUALITY_SAVED.active){const t=await fs.getTemporaryFolder();let n=e.filter(e=>{let t=new ImageFill(`data:image/jpeg;base64,${e}`);return t.naturalHeight*t.naturalHeight>i.QUALITY_SAVED.scale*o*r||(l.push(t),!1)}),c=await n.map(async(e,l)=>{let n=new ImageFill(`data:image/jpeg;base64,${e}`);const c="image/jpeg"===n.mimeType?application.RenditionType.JPG:application.RenditionType.PNG,g="imagemin"+l+"."+c,h=await t.createFile(g,{overwrite:!0});let u=new Rectangle;return u.width=o,u.height=r,u.fill=n,u.name=Helpers.GeneratePassword(),s.push(u.name),a.addChild(u),u.moveInParentCoordinates(-1e4,-1e4),{node:u,type:c,scale:i.QUALITY_SAVED.scale,quality:i.QUALITY_SAVED.quality,outputFile:h}});const g=await Promise.all(c),h=await application.createRenditions(g);return a.children.forEach(e=>{s.forEach(t=>{e.name===t&&e.removeFromParent()})}),l.concat(h.map(e=>new ImageFill(e.outputFile)))}return e.map(e=>new ImageFill(`data:image/jpeg;base64,${e}`))},ImageService.prototype.Apply=function(e,t,a){let i=this,l=[],s=1;return e(s,i.Images.length),i.Images.forEach(t=>{l.push(UnsplashService.Photos.Download(t.links.download_location).then(t=>(s<i.Images.length&&s++,e(s,i.Images.length),t)))}),Promise.all(l).then(e=>i.Resize(e,t,a).then(e=>e),e=>{throw e})},module.exports=new ImageService;